# CVE-2021-44228-LOG4J
We cover more details about CVE-2021-44228 in our blog post available at:

[Log4j / Log4Shell Explained - All You Need to Know](https://www.truesec.com/hub/blog/log4j-log4shell-explained-all-you-need-to-know)

[Log4j - How To Secure Your VMware Horizon, UAG and vCenter Servers Against the Log4Shell vulnerability (CVE-2021-44228)](https://www.truesec.com/hub/blog/how-to-secure-your-vmware-horizon-servers-against-log4shell-cve-2021-44228)

[Log4Shell / Apache Log4j Injection Vulnerability CVE-2021-44228: Impact and Response](https://www.truesec.com/hub/blog/apache-log4j-injection-vulnerability-cve-2021-44228-impact-and-response)

# Description
The scripts checks for *.jar, *.war and *.ear files - looks for these classes or pattern - log4j|jndilookup|jndimanager|socketnode - the scripts also checks for nested java files in one sublevel and looks for the same classes and patterns inside of those.
 
The scripts outputs 3 files, one transcript, one list off all found files and one file listing java files that matched (full path).
 
The scripts DOES NOT check any hashes, versions or similar - so the result might contain false positives, but it will give indication of where to investigate further.

# Instructions:
## Linux
[tsxlog4jchecker.sh](https://github.com/Truesec/CSIRT/blob/main/CVE-2021-44228-LOG4J/tsxlog4jchecker.sh)

Place the script in /tmp folder and execute from there, the script will create a subfolder where it will create the result files.

The script scans the file system starting at the path defined in BASE_DIR. Consider changing this to a specific path if required.

## Windows
[Invoke-TSxLOG4JChecker.ps1](https://github.com/Truesec/CSIRT/blob/main/CVE-2021-44228-LOG4J/Invoke-TSxLOG4JChecker.ps1)

Place the script in a folder and execute the script elevated with administrative privileges, the script will create a subfolder where it will create the result files.

For remote execution on multiple systems, the script can be copied to Windows\Temp folder and executed there. Invoke-Command, Invoke-WmiMethod, use of psexec etc. or other means of remote execution should be valid.

Remember to copy back the results to some central location if executed remotely.

Please note that executing on multiple systems might have inpact on eventual underlaying infrastructure - make sure to execute in smaller batches accordingly.

## Parsing Script
[Invoke-TSxLOG4JParser.ps1](https://github.com/Truesec/CSIRT/blob/main/CVE-2021-44228-LOG4J/Invoke-TSxLOG4JParser.ps1)

Place all result files from the scripts Invoke-TSxLOG4JChecker.ps1 and tslog4jchecker.sh directly to the folder "log4j_check_result" - (Default WorkPath is "$PSScriptRoot\log4j_check_result").

The parsing script will combine all files and create a CSV file for better overview.

The CSV file contains ComputerName, TimeStamp, File, Match, Error.

In the case of Error is set to TRUE, find out what the error was and determine if action is needed.

| ComputerName | TimeStamp | File | Match | Error |
| --- | --- | --- | --- | --- |
| Name of the system [STRING] | Timestamp when checker was invoked [DATE] | Filename of checked file [STRING] | If file match to search criterias in checker [TRUE/FALSE] | If transcriptlogs contains errors [TRUE/FALSE]


# Compability:
Linux
Tested on:
- Ubuntu - 11.04, 18.04, 20.04

Windows
Tested on:
- Windows 10, PowerShell version 5.1
- Windows Server 2019, PowerShell version 5.1
- Windows Server 2016, PowerShell version 5.1
- Windows Server 2012 R2, PowerShell 4.0
- Windows Server 2012, PowerShell 3.0

(does not work on Windows Server 2008R2 with PowerShell version 2.0, should work with newer PowerShell version, but so far untested)
